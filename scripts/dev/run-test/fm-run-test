#!/usr/bin/env bash

set -eo pipefail

test_name="$1"
shift 1

if [ -z "$test_name" ]; then
    >&2 "error: no test name"
    exit 1
fi

version_str="${FM_RUN_TEST_VERSIONS:+ ($FM_RUN_TEST_VERSIONS)}"
out_path="$(mktemp --tmpdir fm-XXXXX)"
export FM_TEST_NAME="$test_name"

echo "## START: $test_name$version_str"

on_error() {
  echo "## FAILED: $test_name$version_str; OUT:"
  cat "$out_path"
  echo "## FAILED: $test_name$version_str; END"
}

on_exit() {
    rm -Rf "$CARGO_BUILD_TARGET_DIR"
}
trap on_error ERR

"$@" 2>&1 | ts -s > "$out_path"

echo "## COMPLETE: $test_name$version_str"
